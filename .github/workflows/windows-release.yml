name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.2.2)"
        required: true
      title:
        description: "Release title (optional, defaults to tag)"
        required: false

permissions:
  contents: write

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install frontend deps
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Flatten Next.js standalone output
        shell: pwsh
        run: |
          $standalone = "frontend/.next/standalone"
          $serverJs = Get-ChildItem -Path $standalone -Recurse -Filter server.js |
            Where-Object { $_.FullName -notmatch '\\node_modules\\' } |
            Select-Object -First 1

          if (-not $serverJs) { throw "server.js not found in .next/standalone" }

          $serverDir = Split-Path $serverJs.FullName
          $flat = "frontend/.next/standalone-flat"

          if (Test-Path $flat) { Remove-Item -Recurse -Force $flat }
          Copy-Item -Recurse -Force $serverDir $flat

      - name: Build backend (PyInstaller)
        shell: pwsh
        run: |
          python -m venv backend/venv
          .\backend\venv\Scripts\activate
          pip install -r backend\requirements.txt
          pip install pyinstaller
          if (Test-Path backend\build) { Remove-Item -Recurse -Force backend\build }
          if (Test-Path backend\dist) { Remove-Item -Recurse -Force backend\dist }
          pyinstaller backend\mussel-backend.spec

      - name: Install electron deps
        working-directory: electron
        run: npm install

      - name: Build Windows installer
        working-directory: electron
        run: npm run dist:win

      - name: Create GitHub release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          TITLE="${{ inputs.title }}"
          if [ -z "$TITLE" ]; then
            TITLE="$TAG"
          fi
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --title "$TITLE"

      - name: Upload release assets
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          gh release upload "$TAG" dist/*.exe dist/*.yml dist/*.blockmap --clobber
